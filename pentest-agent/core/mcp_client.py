# -*- coding: utf-8 -*-
"""
MCP Client
统一的 MCP 服务器通信客户端
"""

import json
import time
from typing import Dict, Any, Optional, List
import requests

from core.config_loader import get_mcp_config


class MCPClient:
    """MCP 服务器通信客户端"""
    
    def __init__(self):
        """初始化 MCP 客户端"""
        self._config = get_mcp_config()
        self._server_url = self._config.get("server_url", "http://localhost:8000")
        self._api_key = self._config.get("api_key", "")
        self._timeout = self._config.get("request_timeout", 30)
        self._verify_ssl = self._config.get("verify_ssl", True)
        
        self._server_url = self._server_url.rstrip("/")
        self._mcp_endpoint = f"{self._server_url}/mcp"
    
    def _make_request(self, method: str, params: Dict[str, Any]) -> Dict[str, Any]:
        """发送 JSON-RPC 请求"""
        payload = {
            "jsonrpc": "2.0",
            "id": int(time.time() * 1000),
            "method": method,
            "params": params
        }
        
        headers = {
            "X-API-key": self._api_key,
            "Content-Type": "application/json"
        }
        
        try:
            response = requests.post(
                self._mcp_endpoint,
                json=payload,
                headers=headers,
                timeout=self._timeout,
                verify=self._verify_ssl
            )
            response.raise_for_status()
            return response.json()
        except requests.exceptions.Timeout:
            return {"jsonrpc": "2.0", "error": {"code": -32000, "message": f"请求超时（{self._timeout}秒）"}}
        except requests.exceptions.ConnectionError:
            return {"jsonrpc": "2.0", "error": {"code": -32001, "message": f"无法连接到 MCP 服务器: {self._server_url}"}}
        except Exception as e:
            return {"jsonrpc": "2.0", "error": {"code": -32002, "message": str(e)}}
    
    def call_tool(self, tool_name: str, arguments: Dict[str, Any]) -> Dict[str, Any]:
        """调用 MCP 工具"""
        response = self._make_request("tools/call", {"name": tool_name, "arguments": arguments})
        
        if "error" in response:
            return {"success": False, "error": response["error"].get("message", "未知错误")}
        
        if "result" in response:
            content = response["result"].get("content", [])
            if content and len(content) > 0:
                text = content[0].get("text", "")
                try:
                    return json.loads(text)
                except json.JSONDecodeError:
                    return {"success": True, "output": text}
        
        return {"success": False, "error": "响应格式错误"}
    
    def list_tools(self) -> Dict[str, Any]:
        """获取可用工具列表"""
        response = self._make_request("tools/list", {})
        if "error" in response:
            return {"success": False, "error": response["error"].get("message")}
        if "result" in response:
            return {"success": True, "tools": response["result"].get("tools", [])}
        return {"success": False, "error": "响应格式错误"}
    
    def health_check(self) -> bool:
        """检查 MCP 服务器健康状态"""
        try:
            response = requests.get(f"{self._server_url}/health", timeout=5, verify=self._verify_ssl)
            return response.status_code == 200
        except:
            return False
    
    # === 任务戳管理 ===
    
    def generate_stamp(self, mission_name: str, target: str, operator: str = "shadow_commander", tags: Optional[List[str]] = None) -> Dict[str, Any]:
        return self.call_tool("generate_stamp", {"mission_name": mission_name, "target": target, "operator": operator, "tags": tags or []})
    
    def get_stamp_info(self, stamp: str) -> Dict[str, Any]:
        return self.call_tool("get_stamp_info", {"stamp": stamp})
    
    def list_stamps(self) -> Dict[str, Any]:
        return self.call_tool("list_stamps", {})
    
    def add_finding(self, stamp: str, vuln_type: str, severity: str, description: str, evidence: Optional[Dict] = None) -> Dict[str, Any]:
        return self.call_tool("add_finding", {"stamp": stamp, "vuln_type": vuln_type, "severity": severity, "description": description, "evidence": evidence or {}})
    
    def update_stamp_status(self, stamp: str, status: str, notes: Optional[str] = None) -> Dict[str, Any]:
        return self.call_tool("update_stamp_status", {"stamp": stamp, "status": status, "notes": notes})
    
    # === 任务执行 ===
    
    def deploy_and_run_task(self, stamp: str, script_name: str, script_content: str) -> Dict[str, Any]:
        return self.call_tool("deploy_and_run_task", {"stamp": stamp, "script_name": script_name, "script_content": script_content})
    
    def get_task_status(self, stamp: Optional[str] = None, task_id: Optional[str] = None) -> Dict[str, Any]:
        args = {}
        if stamp:
            args["stamp"] = stamp
        if task_id:
            args["task_id"] = task_id
        return self.call_tool("get_task_status", args)
    
    def get_task_result(self, stamp: str, task_id: str, tail_lines: int = 50) -> Dict[str, Any]:
        return self.call_tool("get_task_result", {"stamp": stamp, "task_id": task_id, "tail_lines": tail_lines})
    
    def cancel_task(self, stamp: str, task_id: str) -> Dict[str, Any]:
        return self.call_tool("cancel_task", {"stamp": stamp, "task_id": task_id})
    
    # === 文件操作 ===
    
    def list_workspace_files(self, stamp: str) -> Dict[str, Any]:
        return self.call_tool("list_workspace_files", {"stamp": stamp})
    
    def read_workspace_file(self, stamp: str, filename: str, max_lines: int = 100) -> Dict[str, Any]:
        return self.call_tool("read_workspace_file", {"stamp": stamp, "filename": filename, "max_lines": max_lines})


# 全局客户端实例
_mcp_client: Optional[MCPClient] = None


def get_mcp_client() -> MCPClient:
    """获取 MCP 客户端单例"""
    global _mcp_client
    if _mcp_client is None:
        _mcp_client = MCPClient()
    return _mcp_client
