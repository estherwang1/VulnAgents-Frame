# -*- coding: utf-8 -*-
"""
Config Loader
配置和提示词加载器
"""

import os
import re
from pathlib import Path
from typing import Dict, Any, Optional
import yaml
from dotenv import load_dotenv

# 加载 .env 文件
load_dotenv()


class ConfigLoader:
    """配置加载器"""
    
    def __init__(self, config_dir: str = None):
        """
        初始化配置加载器
        
        Args:
            config_dir: 配置目录路径，默认为项目根目录下的 config/
        """
        if config_dir:
            self.config_dir = Path(config_dir)
        else:
            # 默认为当前文件所在目录的上级的 config/
            self.config_dir = Path(__file__).parent.parent / "config"
        
        self.prompts_dir = self.config_dir / "prompts"
        
        # 缓存
        self._system_config: Optional[Dict[str, Any]] = None
        self._tools_config: Optional[Dict[str, Any]] = None
        self._prompts_cache: Dict[str, str] = {}
    
    def _expand_env_vars(self, value: Any) -> Any:
        """
        展开环境变量
        
        支持格式：
        - ${VAR} - 必须存在
        - ${VAR:default} - 带默认值
        """
        if isinstance(value, str):
            # 匹配 ${VAR} 或 ${VAR:default}
            pattern = r'\$\{([^}:]+)(?::([^}]*))?\}'
            
            def replacer(match):
                var_name = match.group(1)
                default_value = match.group(2)
                
                env_value = os.getenv(var_name)
                if env_value is not None:
                    return env_value
                elif default_value is not None:
                    return default_value
                else:
                    # 环境变量不存在且没有默认值，保持原样
                    return match.group(0)
            
            return re.sub(pattern, replacer, value)
        
        elif isinstance(value, dict):
            return {k: self._expand_env_vars(v) for k, v in value.items()}
        
        elif isinstance(value, list):
            return [self._expand_env_vars(item) for item in value]
        
        return value
    
    def load_yaml(self, filename: str) -> Dict[str, Any]:
        """
        加载 YAML 配置文件
        
        Args:
            filename: 文件名（相对于 config_dir）
            
        Returns:
            配置字典
        """
        filepath = self.config_dir / filename
        
        if not filepath.exists():
            raise FileNotFoundError(f"配置文件不存在: {filepath}")
        
        with open(filepath, "r", encoding="utf-8") as f:
            config = yaml.safe_load(f)
        
        # 展开环境变量
        return self._expand_env_vars(config)
    
    @property
    def system(self) -> Dict[str, Any]:
        """获取系统配置"""
        if self._system_config is None:
            self._system_config = self.load_yaml("system.yaml")
        return self._system_config
    
    @property
    def tools(self) -> Dict[str, Any]:
        """获取工具配置"""
        if self._tools_config is None:
            self._tools_config = self.load_yaml("tools.yaml")
        return self._tools_config
    
    def load_prompt(self, agent_name: str) -> str:
        """
        加载代理提示词
        
        Args:
            agent_name: 代理名称（不含扩展名）
            
        Returns:
            提示词内容
        """
        if agent_name in self._prompts_cache:
            return self._prompts_cache[agent_name]
        
        prompt_file = self.prompts_dir / f"{agent_name}.md"
        
        if not prompt_file.exists():
            raise FileNotFoundError(f"提示词文件不存在: {prompt_file}")
        
        with open(prompt_file, "r", encoding="utf-8") as f:
            prompt = f.read()
        
        self._prompts_cache[agent_name] = prompt
        return prompt
    
    def get_mcp_config(self) -> Dict[str, Any]:
        """获取 MCP 配置"""
        return self.system.get("mcp", {})
    
    def get_model_config(self) -> Dict[str, Any]:
        """获取模型配置"""
        return self.system.get("model", {})
    
    def get_paths_config(self) -> Dict[str, Any]:
        """获取路径配置"""
        return self.system.get("paths", {})
    
    def get_tool_groups(self, group_name: str) -> list:
        """
        获取工具组
        
        Args:
            group_name: 工具组名称
            
        Returns:
            工具名称列表
        """
        groups = self.tools.get("tool_groups", {})
        return groups.get(group_name, [])
    
    def get_remote_tools(self) -> Dict[str, Any]:
        """获取远程工具定义"""
        return self.tools.get("remote_tools", {})
    
    def get_local_tools(self) -> Dict[str, Any]:
        """获取本地工具定义"""
        return self.tools.get("local_tools", {})
    
    def is_debug_mode(self) -> bool:
        """是否调试模式"""
        debug_config = self.system.get("debug", {})
        enabled = debug_config.get("enabled", "false")
        return str(enabled).lower() == "true"
    
    def print_config(self):
        """打印配置信息"""
        print("=" * 60)
        print("Configuration Loaded")
        print("=" * 60)
        
        mcp = self.get_mcp_config()
        print(f"MCP Server: {mcp.get('server_url', 'N/A')}")
        print(f"MCP Key: {'*' * 8 if mcp.get('api_key') else 'N/A'}")
        
        model = self.get_model_config()
        print(f"Model: {model.get('name', 'N/A')}")
        
        paths = self.get_paths_config()
        print(f"Local Workspace: {paths.get('local_workspace', 'N/A')}")
        
        print(f"Debug Mode: {self.is_debug_mode()}")
        print("=" * 60)


# 全局配置加载器实例
config_loader = ConfigLoader()


# 便捷函数
def get_system_config() -> Dict[str, Any]:
    """获取系统配置"""
    return config_loader.system


def get_tools_config() -> Dict[str, Any]:
    """获取工具配置"""
    return config_loader.tools


def load_prompt(agent_name: str) -> str:
    """加载代理提示词"""
    return config_loader.load_prompt(agent_name)


def get_mcp_config() -> Dict[str, Any]:
    """获取 MCP 配置"""
    return config_loader.get_mcp_config()


def get_model_config() -> Dict[str, Any]:
    """获取模型配置"""
    return config_loader.get_model_config()


def get_paths_config() -> Dict[str, Any]:
    """获取路径配置"""
    return config_loader.get_paths_config()
