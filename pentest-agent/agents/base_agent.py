# -*- coding: utf-8 -*-
"""
Base Agent
子代理基类，提供共享功能
"""

from typing import List, Optional
from langchain_anthropic import ChatAnthropic
from langchain_core.messages import AIMessage, HumanMessage, SystemMessage
from langgraph.prebuilt import create_react_agent

from core.config_loader import load_prompt, get_model_config


def create_model():
    """
    根据配置创建 LLM 实例
    
    Returns:
        ChatAnthropic 实例
    """
    config = get_model_config()
    
    kwargs = {
        "model": config.get("name", "claude-sonnet-4-20250514"),
        "temperature": config.get("temperature", 0),
        "max_tokens": config.get("max_tokens", 4096),
    }
    
    # 如果配置了 base_url（聚合平台）
    base_url = config.get("base_url")
    if base_url:
        kwargs["base_url"] = base_url
        # 聚合平台可能默认开启 thinking，需要禁用
        kwargs["model_kwargs"] = {
            "thinking": {"type": "disabled"}
        }
    
    return ChatAnthropic(**kwargs)


def clean_messages(messages: List) -> List:
    """
    清理消息列表，修复可能导致 API 错误的问题
    
    - 移除 assistant 消息末尾的空白字符
    - 确保消息内容不为空
    """
    cleaned = []
    for msg in messages:
        if isinstance(msg, AIMessage):
            content = msg.content
            if isinstance(content, str):
                content = content.rstrip()  # 移除末尾空白
                if content:  # 确保不为空
                    cleaned.append(AIMessage(content=content))
            elif isinstance(content, list):
                # 处理多模态内容
                new_content = []
                for part in content:
                    if isinstance(part, str):
                        part = part.rstrip()
                        if part:
                            new_content.append(part)
                    elif isinstance(part, dict):
                        if 'text' in part:
                            part['text'] = part['text'].rstrip()
                        if part.get('text', True):  # 非空或非文本类型
                            new_content.append(part)
                if new_content:
                    cleaned.append(AIMessage(content=new_content))
        elif isinstance(msg, HumanMessage):
            content = msg.content
            if isinstance(content, str) and content.strip():
                cleaned.append(msg)
            elif isinstance(content, list) and content:
                cleaned.append(msg)
            elif content:
                cleaned.append(msg)
        else:
            cleaned.append(msg)
    
    return cleaned


def create_subagent(
    agent_name: str,
    tools: List,
    model: Optional[ChatAnthropic] = None
):
    """
    创建子代理
    
    Args:
        agent_name: 代理名称，用于加载对应的提示词文件
        tools: 代理可用的工具列表
        model: 可选，自定义模型实例
        
    Returns:
        LangGraph Agent
    """
    system_prompt = load_prompt(agent_name)
    
    if model is None:
        model = create_model()
    
    return create_react_agent(
        model=model,
        tools=tools,
        prompt=system_prompt
    )


class SubAgentFactory:
    """子代理工厂"""
    
    def __init__(self):
        self._agents = {}
        self._model = None
    
    def _get_shared_model(self):
        """获取共享的模型实例"""
        if self._model is None:
            self._model = create_model()
        return self._model
    
    def get_or_create(self, agent_name: str, tools: List):
        """获取或创建子代理"""
        if agent_name not in self._agents:
            self._agents[agent_name] = create_subagent(
                agent_name=agent_name,
                tools=tools,
                model=self._get_shared_model()
            )
        return self._agents[agent_name]
    
    def clear(self):
        """清除所有缓存"""
        self._agents.clear()
        self._model = None


# 全局工厂实例
agent_factory = SubAgentFactory()
