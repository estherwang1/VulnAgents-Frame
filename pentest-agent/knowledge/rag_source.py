# -*- coding: utf-8 -*-
"""
RAG (Retrieval-Augmented Generation) 数据源
支持本地文档检索
"""

import os
from typing import Optional, List
from pathlib import Path

from .base import KnowledgeSource, KnowledgeResult


class RAGSource(KnowledgeSource):
    """
    RAG 本地知识库
    
    支持多种后端：
    - simple: 简单的文本匹配（无需依赖）
    - chroma: ChromaDB 向量数据库
    - faiss: FAISS 向量索引
    """
    
    def __init__(
        self,
        docs_dir: Optional[str] = None,
        backend: str = "simple",
        embedding_model: Optional[str] = None
    ):
        """
        Args:
            docs_dir: 文档目录
            backend: 后端类型 (simple, chroma, faiss)
            embedding_model: 嵌入模型（chroma/faiss 需要）
        """
        self._docs_dir = Path(docs_dir) if docs_dir else Path("./knowledge_docs")
        self._backend = backend
        self._embedding_model = embedding_model
        self._enabled = True
        self._index = None
        
        # 初始化
        self._init_backend()
    
    @property
    def name(self) -> str:
        return "rag"
    
    @property
    def enabled(self) -> bool:
        return self._enabled and self._docs_dir.exists()
    
    def _init_backend(self):
        """初始化后端"""
        if self._backend == "simple":
            self._init_simple()
        elif self._backend == "chroma":
            self._init_chroma()
        elif self._backend == "faiss":
            self._init_faiss()
    
    def _init_simple(self):
        """简单文本索引"""
        self._documents = []
        
        if not self._docs_dir.exists():
            return
        
        # 加载所有文档
        for ext in ["*.txt", "*.md", "*.json"]:
            for file in self._docs_dir.glob(f"**/{ext}"):
                try:
                    content = file.read_text(encoding="utf-8")
                    self._documents.append({
                        "path": str(file),
                        "filename": file.name,
                        "content": content
                    })
                except:
                    pass
    
    def _init_chroma(self):
        """ChromaDB 向量数据库"""
        try:
            import chromadb
            from chromadb.config import Settings
            
            self._client = chromadb.Client(Settings(
                chroma_db_impl="duckdb+parquet",
                persist_directory=str(self._docs_dir / ".chroma")
            ))
            self._collection = self._client.get_or_create_collection("pentest_docs")
            
        except ImportError:
            print("ChromaDB 未安装，回退到 simple 模式")
            self._backend = "simple"
            self._init_simple()
    
    def _init_faiss(self):
        """FAISS 向量索引"""
        try:
            import faiss
            # TODO: 实现 FAISS 索引
            pass
        except ImportError:
            print("FAISS 未安装，回退到 simple 模式")
            self._backend = "simple"
            self._init_simple()
    
    async def query(self, query: str, **kwargs) -> KnowledgeResult:
        """
        查询本地知识库
        
        Args:
            query: 查询内容
            **kwargs:
                - top_k: 返回结果数量
                - threshold: 相似度阈值
        """
        top_k = kwargs.get("top_k", 5)
        
        if self._backend == "simple":
            results = self._simple_search(query, top_k)
        elif self._backend == "chroma":
            results = await self._chroma_search(query, top_k)
        else:
            results = []
        
        return KnowledgeResult(
            source=self.name,
            query=query,
            results=results,
            confidence=0.8 if results else 0.0,
            raw_response={"backend": self._backend, "doc_count": len(self._documents)}
        )
    
    def _simple_search(self, query: str, top_k: int) -> list:
        """简单的关键词匹配搜索"""
        results = []
        query_lower = query.lower()
        keywords = query_lower.split()
        
        for doc in self._documents:
            content_lower = doc["content"].lower()
            
            # 计算匹配分数
            score = 0
            for kw in keywords:
                if kw in content_lower:
                    score += content_lower.count(kw)
            
            if score > 0:
                # 提取相关片段
                snippet = self._extract_snippet(doc["content"], keywords)
                results.append({
                    "filename": doc["filename"],
                    "score": score,
                    "snippet": snippet,
                    "path": doc["path"]
                })
        
        # 按分数排序
        results.sort(key=lambda x: x["score"], reverse=True)
        return results[:top_k]
    
    async def _chroma_search(self, query: str, top_k: int) -> list:
        """ChromaDB 向量搜索"""
        try:
            results = self._collection.query(
                query_texts=[query],
                n_results=top_k
            )
            
            return [
                {
                    "id": id,
                    "content": doc,
                    "distance": dist
                }
                for id, doc, dist in zip(
                    results["ids"][0],
                    results["documents"][0],
                    results["distances"][0]
                )
            ]
        except:
            return []
    
    def _extract_snippet(self, content: str, keywords: list, context_size: int = 200) -> str:
        """提取包含关键词的片段"""
        content_lower = content.lower()
        
        for kw in keywords:
            pos = content_lower.find(kw)
            if pos != -1:
                start = max(0, pos - context_size // 2)
                end = min(len(content), pos + len(kw) + context_size // 2)
                snippet = content[start:end]
                if start > 0:
                    snippet = "..." + snippet
                if end < len(content):
                    snippet = snippet + "..."
                return snippet
        
        # 没找到关键词，返回开头
        return content[:context_size] + "..." if len(content) > context_size else content
    
    async def health_check(self) -> bool:
        """健康检查"""
        if self._backend == "simple":
            return len(self._documents) > 0
        elif self._backend == "chroma":
            try:
                return self._collection.count() >= 0
            except:
                return False
        return False
    
    def add_document(self, content: str, metadata: dict = None):
        """添加文档到知识库"""
        if self._backend == "simple":
            self._documents.append({
                "content": content,
                "filename": metadata.get("filename", "unknown"),
                "path": metadata.get("path", "")
            })
        elif self._backend == "chroma":
            self._collection.add(
                documents=[content],
                metadatas=[metadata] if metadata else None,
                ids=[metadata.get("id", str(len(self._documents)))]
            )
