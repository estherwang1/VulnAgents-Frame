# -*- coding: utf-8 -*-
"""
NVD (National Vulnerability Database) 数据源
https://nvd.nist.gov/developers/vulnerabilities
"""

import os
import json
from typing import Optional
import urllib.request
import urllib.parse

from .base import KnowledgeSource, KnowledgeResult


class NVDSource(KnowledgeSource):
    """
    NVD 漏洞数据库
    
    免费 API，有速率限制（无 key: 5请求/30秒，有 key: 50请求/30秒）
    """
    
    BASE_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0"
    
    def __init__(self, api_key: Optional[str] = None):
        self._api_key = api_key or os.getenv("NVD_API_KEY")
        self._enabled = True
    
    @property
    def name(self) -> str:
        return "nvd"
    
    @property
    def enabled(self) -> bool:
        return self._enabled
    
    def disable(self):
        self._enabled = False
    
    def enable(self):
        self._enabled = True
    
    async def query(self, query: str, **kwargs) -> KnowledgeResult:
        """
        查询 CVE
        
        Args:
            query: CVE ID (如 CVE-2021-44228) 或关键词
            **kwargs:
                - cpe_name: CPE 名称
                - keyword: 关键词搜索
                - cvss_severity: LOW, MEDIUM, HIGH, CRITICAL
        """
        params = {}
        
        # 判断是 CVE ID 还是关键词
        if query.upper().startswith("CVE-"):
            params["cveId"] = query.upper()
        else:
            params["keywordSearch"] = query
        
        # 额外参数
        if kwargs.get("cpe_name"):
            params["cpeName"] = kwargs["cpe_name"]
        if kwargs.get("cvss_severity"):
            params["cvssV3Severity"] = kwargs["cvss_severity"]
        
        # 限制结果数量
        params["resultsPerPage"] = kwargs.get("limit", 10)
        
        try:
            data = await self._make_request(params)
            results = self._parse_response(data)
            
            return KnowledgeResult(
                source=self.name,
                query=query,
                results=results,
                confidence=1.0 if results else 0.0,
                raw_response=data
            )
        except Exception as e:
            return KnowledgeResult(
                source=self.name,
                query=query,
                results=[],
                confidence=0.0,
                raw_response={"error": str(e)}
            )
    
    async def _make_request(self, params: dict) -> dict:
        """发送 API 请求"""
        url = f"{self.BASE_URL}?{urllib.parse.urlencode(params)}"
        
        headers = {"User-Agent": "PentestAgent/1.0"}
        if self._api_key:
            headers["apiKey"] = self._api_key
        
        req = urllib.request.Request(url, headers=headers)
        
        with urllib.request.urlopen(req, timeout=30) as response:
            return json.loads(response.read().decode())
    
    def _parse_response(self, data: dict) -> list:
        """解析 NVD 响应"""
        results = []
        
        for vuln in data.get("vulnerabilities", []):
            cve = vuln.get("cve", {})
            
            # 提取 CVSS 分数
            cvss_score = None
            cvss_severity = None
            metrics = cve.get("metrics", {})
            
            if "cvssMetricV31" in metrics:
                cvss_data = metrics["cvssMetricV31"][0]["cvssData"]
                cvss_score = cvss_data.get("baseScore")
                cvss_severity = cvss_data.get("baseSeverity")
            elif "cvssMetricV2" in metrics:
                cvss_data = metrics["cvssMetricV2"][0]["cvssData"]
                cvss_score = cvss_data.get("baseScore")
            
            # 提取描述
            descriptions = cve.get("descriptions", [])
            description = next(
                (d["value"] for d in descriptions if d["lang"] == "en"),
                descriptions[0]["value"] if descriptions else ""
            )
            
            results.append({
                "cve_id": cve.get("id"),
                "description": description,
                "cvss_score": cvss_score,
                "cvss_severity": cvss_severity,
                "published": cve.get("published"),
                "references": [
                    ref.get("url") for ref in cve.get("references", [])
                ][:5]  # 只取前5个引用
            })
        
        return results
    
    async def health_check(self) -> bool:
        """健康检查"""
        try:
            # 查询一个已知的 CVE 来测试
            result = await self.query("CVE-2021-44228", limit=1)
            return len(result.results) > 0
        except:
            return False
