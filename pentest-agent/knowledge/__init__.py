# -*- coding: utf-8 -*-
"""
Knowledge Module
知识库模块 - 提供 CVE 查询、漏洞利用搜索、本地文档检索
"""

import os
from typing import Optional

from .base import KnowledgeManager, KnowledgeResult, KnowledgeSource, knowledge_manager
from .nvd_source import NVDSource
from .rag_source import RAGSource
from .exploitdb_source import ExploitDBSource


def setup_knowledge_sources(
    enable_nvd: bool = True,
    enable_rag: bool = True,
    enable_exploitdb: bool = False,
    rag_docs_dir: Optional[str] = None,
    rag_backend: str = "simple"
):
    """
    配置知识源
    
    Args:
        enable_nvd: 启用 NVD CVE 查询
        enable_rag: 启用本地 RAG
        enable_exploitdb: 启用 ExploitDB（需要本地 searchsploit）
        rag_docs_dir: RAG 文档目录
        rag_backend: RAG 后端 (simple, chroma, faiss)
    """
    
    if enable_nvd:
        nvd = NVDSource(api_key=os.getenv("NVD_API_KEY"))
        knowledge_manager.register(nvd, priority=1)
    
    if enable_rag:
        docs_dir = rag_docs_dir or os.getenv("RAG_DOCS_DIR", "./knowledge_docs")
        rag = RAGSource(docs_dir=docs_dir, backend=rag_backend)
        knowledge_manager.register(rag, priority=2)
    
    if enable_exploitdb:
        exploitdb = ExploitDBSource(use_local=True)
        knowledge_manager.register(exploitdb, priority=3)


# 便捷查询函数
async def query_cve(cve_id: str) -> KnowledgeResult:
    """查询 CVE"""
    results = await knowledge_manager.query(cve_id, sources=["nvd"])
    return results[0] if results else None


async def search_exploits(keyword: str) -> KnowledgeResult:
    """搜索漏洞利用"""
    results = await knowledge_manager.query(keyword, sources=["exploitdb"])
    return results[0] if results else None


async def search_docs(query: str) -> KnowledgeResult:
    """搜索本地文档"""
    results = await knowledge_manager.query(query, sources=["rag"])
    return results[0] if results else None


async def search_all(query: str) -> list:
    """搜索所有知识源"""
    return await knowledge_manager.query(query)


__all__ = [
    "KnowledgeManager",
    "KnowledgeResult",
    "KnowledgeSource",
    "knowledge_manager",
    "NVDSource",
    "RAGSource", 
    "ExploitDBSource",
    "setup_knowledge_sources",
    "query_cve",
    "search_exploits",
    "search_docs",
    "search_all",
]
