# -*- coding: utf-8 -*-
"""
ExploitDB 数据源
https://www.exploit-db.com/
"""

import os
import json
from typing import Optional
import urllib.request
import urllib.parse

from .base import KnowledgeSource, KnowledgeResult


class ExploitDBSource(KnowledgeSource):
    """
    ExploitDB 漏洞利用数据库
    
    注意：ExploitDB 没有官方免费 API
    这里使用 searchsploit 的在线版本或爬虫方式
    
    替代方案：
    1. 本地 searchsploit（需要安装 exploitdb）
    2. 使用 exploit-database GitHub 仓库
    """
    
    # exploit-db.com 的搜索 API（非官方）
    SEARCH_URL = "https://www.exploit-db.com/search"
    
    def __init__(self, use_local: bool = False, local_path: Optional[str] = None):
        """
        Args:
            use_local: 是否使用本地 searchsploit
            local_path: 本地 exploitdb 路径
        """
        self._use_local = use_local
        self._local_path = local_path or "/usr/share/exploitdb"
        self._enabled = True
    
    @property
    def name(self) -> str:
        return "exploitdb"
    
    @property
    def enabled(self) -> bool:
        return self._enabled
    
    async def query(self, query: str, **kwargs) -> KnowledgeResult:
        """
        搜索漏洞利用
        
        Args:
            query: 搜索关键词（如 "apache 2.4", "CVE-2021-44228"）
            **kwargs:
                - type: exploit, shellcode, paper
                - platform: linux, windows, etc.
        """
        if self._use_local:
            results = self._local_search(query, **kwargs)
        else:
            results = await self._online_search(query, **kwargs)
        
        return KnowledgeResult(
            source=self.name,
            query=query,
            results=results,
            confidence=0.9 if results else 0.0,
            raw_response={"method": "local" if self._use_local else "online"}
        )
    
    def _local_search(self, query: str, **kwargs) -> list:
        """使用本地 searchsploit 搜索"""
        import subprocess
        
        try:
            cmd = ["searchsploit", "--json", query]
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
            
            if result.returncode == 0:
                data = json.loads(result.stdout)
                return [
                    {
                        "title": exp.get("Title"),
                        "path": exp.get("Path"),
                        "type": exp.get("Type"),
                        "platform": exp.get("Platform"),
                        "date": exp.get("Date")
                    }
                    for exp in data.get("RESULTS_EXPLOIT", [])
                ]
        except:
            pass
        
        return []
    
    async def _online_search(self, query: str, **kwargs) -> list:
        """
        在线搜索（简化版）
        
        注意：实际使用可能需要处理反爬
        """
        # 由于 ExploitDB 没有公开 API，这里返回搜索链接
        # 实际项目中可以考虑：
        # 1. 使用 GitHub API 搜索 exploit-database 仓库
        # 2. 维护本地镜像
        # 3. 使用第三方 API 服务
        
        search_url = f"https://www.exploit-db.com/search?q={urllib.parse.quote(query)}"
        
        return [{
            "message": "ExploitDB 需要本地 searchsploit 或手动搜索",
            "search_url": search_url,
            "suggestion": f"请访问 {search_url} 或安装 exploitdb 包使用本地搜索"
        }]
    
    async def health_check(self) -> bool:
        """健康检查"""
        if self._use_local:
            import shutil
            return shutil.which("searchsploit") is not None
        return True  # 在线搜索总是"可用"（虽然可能被限制）
