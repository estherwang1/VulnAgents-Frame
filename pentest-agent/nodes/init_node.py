# -*- coding: utf-8 -*-
"""
Init Node
初始化节点 - 生成任务戳
"""

from langchain_core.messages import AIMessage

from core.state import PentestState
from tools.remote_tools import generate_stamp
import json


def init_node(state: PentestState) -> dict:
    """
    初始化节点
    
    职责：
    1. 生成任务戳
    2. 初始化任务状态
    """
    target = state.get("target", "")
    mission_name = state.get("mission_name", "渗透测试任务")
    
    if not target:
        return {
            "error": "目标未指定",
            "messages": [AIMessage(content="错误：请指定渗透测试目标")]
        }
    
    # 生成任务戳
    result_str = generate_stamp.invoke({
        "mission_name": mission_name,
        "target": target,
        "operator": "shadow_commander",
        "tags": ["auto", "langgraph"]
    })
    
    try:
        result = json.loads(result_str)
        stamp = result.get("stamp", "")
        
        if not stamp:
            return {
                "error": "任务戳生成失败",
                "messages": [AIMessage(content=f"任务戳生成失败: {result}")]
            }
        
        return {
            "stamp": stamp,
            "current_phase": "init",
            "messages": [AIMessage(content=f"""
## 任务初始化完成

- **任务戳**: {stamp}
- **目标**: {target}
- **任务名称**: {mission_name}

准备开始渗透测试，首先进行侦察阶段。
""")]
        }
    
    except json.JSONDecodeError as e:
        return {
            "error": f"解析任务戳响应失败: {e}",
            "messages": [AIMessage(content=f"任务戳响应解析失败: {result_str}")]
        }
