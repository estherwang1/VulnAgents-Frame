# -*- coding: utf-8 -*-
"""
Remote Tools
通过 MCP 服务器执行的远程工具
"""

import json
from typing import Optional, List, Dict, Any
from langchain_core.tools import tool

from core.mcp_client import get_mcp_client


# ============================================================
# 任务戳管理工具
# ============================================================

@tool
def generate_stamp(
    mission_name: str,
    target: str,
    operator: str = "shadow_commander",
    tags: Optional[List[str]] = None
) -> str:
    """
    生成新的任务戳，用于追踪整个渗透测试任务的生命周期。
    
    任务戳格式：SHADOW-YYYYMMDD-HHMMSS-XXXX
    
    Args:
        mission_name: 任务名称，如 "Web应用渗透测试"
        target: 目标IP或域名，如 "192.168.1.1" 或 "example.com"
        operator: 操作者名称，默认 "shadow_commander"
        tags: 任务标签列表，如 ["web", "internal"]
        
    Returns:
        JSON 格式的结果，包含 stamp ID 和工作空间路径
    """
    client = get_mcp_client()
    result = client.generate_stamp(mission_name, target, operator, tags)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def get_stamp_info(stamp: str) -> str:
    """
    获取任务戳的详细信息，包括关联的任务、发现的漏洞、事件记录等。
    
    Args:
        stamp: 任务戳ID，格式：SHADOW-YYYYMMDD-HHMMSS-XXXX
        
    Returns:
        JSON 格式的任务戳详细信息
    """
    client = get_mcp_client()
    result = client.get_stamp_info(stamp)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def list_stamps() -> str:
    """
    列出所有活跃的任务戳。
    
    Returns:
        JSON 格式的任务戳列表
    """
    client = get_mcp_client()
    result = client.list_stamps()
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def add_finding(
    stamp: str,
    vuln_type: str,
    severity: str,
    description: str,
    evidence: Optional[Dict[str, Any]] = None
) -> str:
    """
    记录发现的漏洞到任务戳。
    
    Args:
        stamp: 任务戳ID
        vuln_type: 漏洞类型，如 "SQLi", "XSS", "IDOR", "RCE", "CMDi", "LFI"
        severity: 严重程度，必须是 "critical", "high", "medium", "low", "info" 之一
        description: 漏洞详细描述
        evidence: 证据数据，如 {"url": "...", "payload": "...", "response": "..."}
        
    Returns:
        JSON 格式的记录结果
    """
    client = get_mcp_client()
    result = client.add_finding(stamp, vuln_type, severity, description, evidence)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def update_stamp_status(
    stamp: str,
    status: str,
    notes: Optional[str] = None
) -> str:
    """
    更新任务戳状态。
    
    Args:
        stamp: 任务戳ID
        status: 状态，必须是 "active", "completed", "failed", "paused" 之一
        notes: 状态备注
        
    Returns:
        JSON 格式的更新结果
    """
    client = get_mcp_client()
    result = client.update_stamp_status(stamp, status, notes)
    return json.dumps(result, ensure_ascii=False, indent=2)


# ============================================================
# 任务执行工具
# ============================================================

@tool
def deploy_and_run_task(
    stamp: str,
    script_name: str,
    script_content: str
) -> str:
    """
    部署脚本到远程MCP服务器并执行。
    
    这是核心工具：代理生成脚本内容后，通过此工具上传到任务戳的工作空间并执行。
    脚本将在 /root/pentest_workspace/{stamp}/ 目录下运行。
    
    Args:
        stamp: 任务戳ID，脚本将部署到该任务戳的工作空间
        script_name: 脚本文件名，如 "port_scan.py" 或 "sqli_test.py"
        script_content: 完整的脚本内容，必须是可执行的 Python 或 Shell 脚本
        
    Returns:
        JSON 格式的结果，包含 task_id 用于后续查询
        
    Example:
        deploy_and_run_task(
            stamp="SHADOW-20260105-120000-A1B2",
            script_name="scanner.py",
            script_content="#!/usr/bin/env python3\\nimport socket\\n..."
        )
    """
    client = get_mcp_client()
    result = client.deploy_and_run_task(stamp, script_name, script_content)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def get_task_status(
    stamp: Optional[str] = None,
    task_id: Optional[str] = None
) -> str:
    """
    获取任务执行状态。
    
    可以查询特定任务戳下的所有任务，或查询特定任务。
    
    Args:
        stamp: 任务戳ID（可选，不填返回所有任务）
        task_id: 任务ID（可选）
        
    Returns:
        JSON 格式的任务状态列表，包含 status (RUNNING/COMPLETED/FAILED)
    """
    client = get_mcp_client()
    result = client.get_task_status(stamp, task_id)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def get_task_result(
    stamp: str,
    task_id: str,
    tail_lines: int = 50
) -> str:
    """
    获取任务执行结果（日志内容）。
    
    任务完成后，使用此工具获取脚本的输出日志。
    
    Args:
        stamp: 任务戳ID
        task_id: 任务ID（从 deploy_and_run_task 返回获得）
        tail_lines: 读取最后N行日志，默认50行
        
    Returns:
        JSON 格式的结果，包含任务状态和日志内容
    """
    client = get_mcp_client()
    result = client.get_task_result(stamp, task_id, tail_lines)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def cancel_task(stamp: str, task_id: str) -> str:
    """
    取消正在运行的任务。
    
    Args:
        stamp: 任务戳ID
        task_id: 任务ID
        
    Returns:
        JSON 格式的取消结果
    """
    client = get_mcp_client()
    result = client.cancel_task(stamp, task_id)
    return json.dumps(result, ensure_ascii=False, indent=2)


# ============================================================
# 文件操作工具
# ============================================================

@tool
def list_workspace_files(stamp: str) -> str:
    """
    列出任务戳工作空间中的所有文件。
    
    Args:
        stamp: 任务戳ID
        
    Returns:
        JSON 格式的文件列表，包含文件名、大小、修改时间
    """
    client = get_mcp_client()
    result = client.list_workspace_files(stamp)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def read_workspace_file(
    stamp: str,
    filename: str,
    max_lines: int = 100
) -> str:
    """
    读取工作空间中的文件内容。
    
    Args:
        stamp: 任务戳ID
        filename: 文件名
        max_lines: 最大读取行数，默认100行
        
    Returns:
        JSON 格式的结果，包含文件内容
    """
    client = get_mcp_client()
    result = client.read_workspace_file(stamp, filename, max_lines)
    return json.dumps(result, ensure_ascii=False, indent=2)


# ============================================================
# 工具集导出
# ============================================================

# 主代理工具集
MAIN_AGENT_TOOLS = [
    generate_stamp,
    get_stamp_info,
    list_stamps,
    update_stamp_status,
    get_task_status,
]

# 子代理通用工具集
SUBAGENT_TOOLS = [
    deploy_and_run_task,
    get_task_status,
    get_task_result,
    add_finding,
    list_workspace_files,
    read_workspace_file,
]

# 侦察专家工具集（可以生成任务戳）
RECON_TOOLS = SUBAGENT_TOOLS + [generate_stamp]

# 所有远程工具
ALL_REMOTE_TOOLS = [
    generate_stamp,
    get_stamp_info,
    list_stamps,
    add_finding,
    update_stamp_status,
    deploy_and_run_task,
    get_task_status,
    get_task_result,
    cancel_task,
    list_workspace_files,
    read_workspace_file,
]
