# -*- coding: utf-8 -*-
"""
Toolbox Tools
工具库调用工具 - 供 LangGraph Agent 使用
"""

import json
from langchain_core.tools import tool
from core.mcp_client import get_mcp_client


@tool
def list_pentest_tools(category: str = None) -> str:
    """
    列出所有可用的渗透测试工具
    
    Args:
        category: 可选，按分类过滤（recon, sqli, xss, auth, utils）
        
    Returns:
        工具列表，包含名称、描述、参数说明
    """
    client = get_mcp_client()
    params = {}
    if category:
        params["category"] = category
    result = client.call_tool("list_tools", params)
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def get_tool_help(tool_id: str) -> str:
    """
    获取工具的详细使用说明
    
    Args:
        tool_id: 工具 ID，如 "recon/port_scan" 或 "sqli/detect"
        
    Returns:
        工具的详细 schema，包括参数说明和示例
    """
    client = get_mcp_client()
    result = client.call_tool("get_tool_schema", {"tool_id": tool_id})
    return json.dumps(result, ensure_ascii=False, indent=2)


@tool
def run_tool(stamp: str, tool_id: str, params: str) -> str:
    """
    运行渗透测试工具
    
    Args:
        stamp: 任务戳（从 generate_stamp 获取）
        tool_id: 工具 ID，格式为 "分类/工具名"
        params: JSON 格式的参数字符串
        
    Returns:
        执行结果
        
    示例:
        run_tool(stamp, "recon/port_scan", '{"target": "192.168.1.1"}')
        run_tool(stamp, "sqli/detect", '{"url": "http://target/login", "method": "POST", "data": "user=admin&pass=test", "inject_param": "user"}')
    """
    client = get_mcp_client()
    
    try:
        params_dict = json.loads(params) if isinstance(params, str) else params
    except json.JSONDecodeError as e:
        return json.dumps({"success": False, "error": f"参数 JSON 格式错误: {e}"})
    
    result = client.call_tool("run_tool", {
        "stamp": stamp,
        "tool_id": tool_id,
        "params": params_dict
    })
    return json.dumps(result, ensure_ascii=False, indent=2)


# ============================================================
# 快捷工具
# ============================================================

@tool
def port_scan(stamp: str, target: str, ports: str = "") -> str:
    """端口扫描（快捷方式）"""
    params = {"target": target}
    if ports:
        params["ports"] = ports
    return run_tool.invoke({"stamp": stamp, "tool_id": "recon/port_scan", "params": json.dumps(params)})


@tool
def dir_scan(stamp: str, url: str, wordlist: str = "common") -> str:
    """目录扫描（快捷方式）"""
    return run_tool.invoke({"stamp": stamp, "tool_id": "recon/dir_enum", "params": json.dumps({"url": url, "wordlist": wordlist})})


@tool
def sqli_test(stamp: str, url: str, method: str, data: str, inject_param: str) -> str:
    """SQL 注入检测（快捷方式）"""
    return run_tool.invoke({"stamp": stamp, "tool_id": "sqli/detect", "params": json.dumps({
        "url": url, "method": method, "data": data, "inject_param": inject_param
    })})


@tool
def http_get(stamp: str, url: str, headers: str = "") -> str:
    """发送 GET 请求（快捷方式）"""
    params = {"url": url, "method": "GET"}
    if headers:
        params["headers"] = headers
    return run_tool.invoke({"stamp": stamp, "tool_id": "utils/http_request", "params": json.dumps(params)})


@tool
def http_post(stamp: str, url: str, data: str, headers: str = "") -> str:
    """发送 POST 请求（快捷方式）"""
    params = {"url": url, "method": "POST", "data": data}
    if headers:
        params["headers"] = headers
    return run_tool.invoke({"stamp": stamp, "tool_id": "utils/http_request", "params": json.dumps(params)})


# 工具集
TOOLBOX_TOOLS = [list_pentest_tools, get_tool_help, run_tool]
QUICK_TOOLS = [port_scan, dir_scan, sqli_test, http_get, http_post]
ALL_TOOLBOX_TOOLS = TOOLBOX_TOOLS + QUICK_TOOLS