# -*- coding: utf-8 -*-
"""
Toolbox Tools
工具库调用工具 - 供 LangGraph Agent 使用

新版工具库：配置化、参数化
"""

import json
from langchain_core.tools import tool
from core.mcp_client import get_mcp_client


@tool
def list_pentest_tools(category: str = None) -> str:
    """
    列出所有可用的渗透测试工具
    
    获取工具列表，了解可以使用哪些工具。
    
    Args:
        category: 可选，按分类过滤（recon, sqli, xss, auth, utils）
        
    Returns:
        工具列表，包含名称、描述、参数说明
        
    常用工具:
        - recon/port_scan: 端口扫描
        - recon/dir_enum: 目录枚举
        - sqli/detect: SQL 注入检测
        - xss/detect: XSS 检测
        - auth/brute_login: 登录爆破
        - utils/http_request: 自定义 HTTP 请求
    """
    client = get_mcp_client()
    params = {}
    if category:
        params["category"] = category
    return client.call("list_tools", params)


@tool
def get_tool_help(tool_id: str) -> str:
    """
    获取工具的详细使用说明
    
    查看工具的参数定义、使用示例等。
    
    Args:
        tool_id: 工具 ID，如 "recon/port_scan" 或 "sqli/detect"
        
    Returns:
        工具的详细 schema，包括参数说明和示例
    """
    client = get_mcp_client()
    return client.call("get_tool_schema", {"tool_id": tool_id})


@tool
def run_tool(stamp: str, tool_id: str, params: str) -> str:
    """
    运行渗透测试工具
    
    这是核心工具！用于执行各种渗透测试操作。
    
    Args:
        stamp: 任务戳（从 generate_stamp 获取）
        tool_id: 工具 ID，格式为 "分类/工具名"
        params: JSON 格式的参数字符串
        
    Returns:
        执行结果，包含:
        - success: 是否成功
        - data: 结果数据
        - flag: 如果发现 flag 会在这里
        - execution_time: 执行耗时
        
    常用工具示例:
        
        # 端口扫描
        run_tool(stamp, "recon/port_scan", '{"target": "192.168.1.1"}')
        
        # 目录枚举
        run_tool(stamp, "recon/dir_enum", '{"url": "http://target.com"}')
        
        # SQL 注入检测
        run_tool(stamp, "sqli/detect", '''{
            "url": "http://target.com/login",
            "method": "POST",
            "data": "username=admin&password=test",
            "inject_param": "username"
        }''')
        
        # 自定义 HTTP 请求
        run_tool(stamp, "utils/http_request", '{"url": "http://target.com/api", "method": "GET"}')
    """
    client = get_mcp_client()
    
    # 解析参数
    try:
        params_dict = json.loads(params) if isinstance(params, str) else params
    except json.JSONDecodeError as e:
        return json.dumps({
            "success": False, 
            "error": f"参数 JSON 格式错误: {e}"
        })
    
    return client.call("run_tool", {
        "stamp": stamp,
        "tool_id": tool_id,
        "params": params_dict
    })


# ============================================================
# 快捷工具（简化常用操作）
# ============================================================

@tool
def port_scan(stamp: str, target: str, ports: str = "") -> str:
    """
    端口扫描（快捷方式）
    
    Args:
        stamp: 任务戳
        target: 目标 IP 或域名
        ports: 端口列表，如 "80,443,8080" 或 "1-1000"（留空使用默认常用端口）
    """
    params = {"target": target}
    if ports:
        params["ports"] = ports
    return run_tool.invoke({
        "stamp": stamp,
        "tool_id": "recon/port_scan",
        "params": json.dumps(params)
    })


@tool
def dir_scan(stamp: str, url: str, wordlist: str = "common") -> str:
    """
    目录扫描（快捷方式）
    
    Args:
        stamp: 任务戳
        url: 目标 URL
        wordlist: 字典类型（common/api/backup/full）
    """
    return run_tool.invoke({
        "stamp": stamp,
        "tool_id": "recon/dir_enum",
        "params": json.dumps({"url": url, "wordlist": wordlist})
    })


@tool
def sqli_test(stamp: str, url: str, method: str, data: str, inject_param: str) -> str:
    """
    SQL 注入检测（快捷方式）
    
    Args:
        stamp: 任务戳
        url: 目标 URL
        method: HTTP 方法（GET/POST）
        data: 参数，格式 key1=value1&key2=value2
        inject_param: 要注入的参数名
    """
    return run_tool.invoke({
        "stamp": stamp,
        "tool_id": "sqli/detect",
        "params": json.dumps({
            "url": url,
            "method": method,
            "data": data,
            "inject_param": inject_param
        })
    })


@tool
def http_get(stamp: str, url: str, headers: str = "") -> str:
    """
    发送 GET 请求（快捷方式）
    
    Args:
        stamp: 任务戳
        url: 请求 URL
        headers: 可选，请求头（格式: Header1:Value1;Header2:Value2）
    """
    params = {"url": url, "method": "GET"}
    if headers:
        params["headers"] = headers
    return run_tool.invoke({
        "stamp": stamp,
        "tool_id": "utils/http_request",
        "params": json.dumps(params)
    })


@tool
def http_post(stamp: str, url: str, data: str, headers: str = "") -> str:
    """
    发送 POST 请求（快捷方式）
    
    Args:
        stamp: 任务戳
        url: 请求 URL
        data: 表单数据（格式: key1=value1&key2=value2）
        headers: 可选，请求头
    """
    params = {"url": url, "method": "POST", "data": data}
    if headers:
        params["headers"] = headers
    return run_tool.invoke({
        "stamp": stamp,
        "tool_id": "utils/http_request",
        "params": json.dumps(params)
    })


# ============================================================
# 工具集
# ============================================================

# 基础工具集（推荐）
TOOLBOX_TOOLS = [
    list_pentest_tools,
    get_tool_help,
    run_tool,
]

# 快捷工具集
QUICK_TOOLS = [
    port_scan,
    dir_scan,
    sqli_test,
    http_get,
    http_post,
]

# 全部工具
ALL_TOOLBOX_TOOLS = TOOLBOX_TOOLS + QUICK_TOOLS
