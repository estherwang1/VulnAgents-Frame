# -*- coding: utf-8 -*-
"""
Knowledge Tools
知识库查询工具 - 供智能体调用
"""

import json
import asyncio
from typing import Optional
from langchain_core.tools import tool


def _run_async(coro):
    """在同步上下文中运行异步函数"""
    try:
        loop = asyncio.get_event_loop()
    except RuntimeError:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
    return loop.run_until_complete(coro)


@tool
def query_cve(cve_id: str) -> str:
    """
    查询 CVE 漏洞详情
    
    从 NVD (National Vulnerability Database) 查询 CVE 信息，
    包括漏洞描述、CVSS 评分、影响版本、参考链接等。
    
    Args:
        cve_id: CVE 编号，如 "CVE-2021-44228"
        
    Returns:
        JSON 格式的 CVE 详情
    """
    from knowledge import query_cve as _query_cve
    
    result = _run_async(_query_cve(cve_id))
    
    if result and result.results:
        return json.dumps({
            "success": True,
            "source": result.source,
            "data": result.results
        }, ensure_ascii=False, indent=2)
    else:
        return json.dumps({
            "success": False,
            "message": f"未找到 {cve_id} 的相关信息"
        }, ensure_ascii=False)


@tool
def search_vulnerabilities(keyword: str, severity: Optional[str] = None) -> str:
    """
    搜索漏洞信息
    
    根据关键词搜索相关漏洞，支持按服务名、产品名、漏洞类型搜索。
    
    Args:
        keyword: 搜索关键词，如 "Apache 2.4" 或 "Log4j"
        severity: 可选，筛选严重程度 (LOW, MEDIUM, HIGH, CRITICAL)
        
    Returns:
        JSON 格式的漏洞列表
    """
    from knowledge import knowledge_manager
    
    kwargs = {}
    if severity:
        kwargs["cvss_severity"] = severity.upper()
    
    results = _run_async(knowledge_manager.query(keyword, sources=["nvd"], **kwargs))
    
    if results and results[0].results:
        return json.dumps({
            "success": True,
            "source": "nvd",
            "count": len(results[0].results),
            "vulnerabilities": results[0].results
        }, ensure_ascii=False, indent=2)
    else:
        return json.dumps({
            "success": False,
            "message": f"未找到与 '{keyword}' 相关的漏洞"
        }, ensure_ascii=False)


@tool
def search_exploits(keyword: str) -> str:
    """
    搜索漏洞利用代码
    
    从 ExploitDB 搜索可用的漏洞利用代码和 PoC。
    
    Args:
        keyword: 搜索关键词，如 "Apache Struts" 或 CVE 编号
        
    Returns:
        JSON 格式的利用代码列表或搜索建议
    """
    from knowledge import search_exploits as _search_exploits
    
    result = _run_async(_search_exploits(keyword))
    
    if result and result.results:
        return json.dumps({
            "success": True,
            "source": result.source,
            "data": result.results
        }, ensure_ascii=False, indent=2)
    else:
        return json.dumps({
            "success": False,
            "message": f"未找到 '{keyword}' 的利用代码",
            "suggestion": "请尝试使用更具体的关键词或 CVE 编号"
        }, ensure_ascii=False)


@tool
def search_knowledge_base(query: str) -> str:
    """
    搜索本地知识库
    
    从本地渗透测试文档库中检索相关信息，
    包括漏洞分析、利用技巧、工具使用指南等。
    
    Args:
        query: 搜索查询，如 "SQL注入绕过WAF" 或 "提权技巧"
        
    Returns:
        JSON 格式的相关文档片段
    """
    from knowledge import search_docs
    
    result = _run_async(search_docs(query))
    
    if result and result.results:
        return json.dumps({
            "success": True,
            "source": "local_rag",
            "count": len(result.results),
            "documents": result.results
        }, ensure_ascii=False, indent=2)
    else:
        return json.dumps({
            "success": False,
            "message": "本地知识库中未找到相关内容",
            "suggestion": "请尝试其他关键词或查询在线资源"
        }, ensure_ascii=False)


# 知识库工具集
KNOWLEDGE_TOOLS = [
    query_cve,
    search_vulnerabilities,
    search_exploits,
    search_knowledge_base,
]
