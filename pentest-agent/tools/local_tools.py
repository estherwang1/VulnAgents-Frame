# -*- coding: utf-8 -*-
"""
Local Tools
在 LangGraph 本地环境执行的工具
"""

import os
from pathlib import Path
from typing import Optional
from langchain_core.tools import tool

from core.config_loader import get_paths_config


def _get_workspace() -> Path:
    """获取本地工作空间路径"""
    paths = get_paths_config()
    workspace = paths.get("local_workspace", "/workspace")
    return Path(workspace)


def _get_mission_log_path() -> Path:
    """获取任务账本路径"""
    paths = get_paths_config()
    log_path = paths.get("mission_log", "/workspace/mission.md")
    return Path(log_path)


def _safe_path(base: Path, relative: str) -> Optional[Path]:
    """
    安全地解析相对路径，防止路径遍历攻击
    
    Args:
        base: 基础目录
        relative: 相对路径
        
    Returns:
        安全的完整路径，如果路径不安全返回 None
    """
    # 规范化路径
    full_path = (base / relative).resolve()
    
    # 确保路径在基础目录内
    try:
        full_path.relative_to(base.resolve())
        return full_path
    except ValueError:
        return None


@tool
def write_local_file(
    filepath: str,
    content: str,
    append: bool = False
) -> str:
    """
    在本地工作空间写入文件。
    
    Args:
        filepath: 文件路径（相对于工作空间），如 "scripts/scanner.py"
        content: 文件内容
        append: 是否追加模式，默认 False（覆盖）
        
    Returns:
        操作结果
    """
    workspace = _get_workspace()
    safe_path = _safe_path(workspace, filepath)
    
    if not safe_path:
        return f"错误：路径不安全: {filepath}"
    
    try:
        # 确保目录存在
        safe_path.parent.mkdir(parents=True, exist_ok=True)
        
        # 写入文件
        mode = "a" if append else "w"
        with open(safe_path, mode, encoding="utf-8") as f:
            f.write(content)
        
        return f"成功：文件已写入 {safe_path}"
    
    except Exception as e:
        return f"错误：写入失败 - {str(e)}"


@tool
def read_local_file(filepath: str) -> str:
    """
    读取本地工作空间的文件。
    
    Args:
        filepath: 文件路径（相对于工作空间）
        
    Returns:
        文件内容
    """
    workspace = _get_workspace()
    safe_path = _safe_path(workspace, filepath)
    
    if not safe_path:
        return f"错误：路径不安全: {filepath}"
    
    if not safe_path.exists():
        return f"错误：文件不存在: {filepath}"
    
    try:
        with open(safe_path, "r", encoding="utf-8") as f:
            content = f.read()
        return content
    
    except Exception as e:
        return f"错误：读取失败 - {str(e)}"


@tool
def update_mission_log(content: str, append: bool = True) -> str:
    """
    更新任务账本（mission.md）。
    
    任务账本是主代理维护的核心文档，记录任务进度和发现。
    
    Args:
        content: 要写入的内容
        append: 是否追加模式，默认 True
        
    Returns:
        操作结果
    """
    log_path = _get_mission_log_path()
    
    try:
        # 确保目录存在
        log_path.parent.mkdir(parents=True, exist_ok=True)
        
        if append:
            # 追加模式，添加分隔符
            existing_content = ""
            if log_path.exists():
                with open(log_path, "r", encoding="utf-8") as f:
                    existing_content = f.read()
            
            # 如果文件不为空，添加空行
            separator = "\n\n" if existing_content.strip() else ""
            
            with open(log_path, "w", encoding="utf-8") as f:
                f.write(existing_content + separator + content)
        else:
            # 覆盖模式
            with open(log_path, "w", encoding="utf-8") as f:
                f.write(content)
        
        return f"成功：任务账本已更新"
    
    except Exception as e:
        return f"错误：更新账本失败 - {str(e)}"


@tool
def read_mission_log() -> str:
    """
    读取任务账本（mission.md）。
    
    Returns:
        任务账本内容
    """
    log_path = _get_mission_log_path()
    
    if not log_path.exists():
        return "(任务账本尚未创建)"
    
    try:
        with open(log_path, "r", encoding="utf-8") as f:
            return f.read()
    except Exception as e:
        return f"错误：读取账本失败 - {str(e)}"


@tool
def list_local_files(directory: str = "") -> str:
    """
    列出本地工作空间中的文件。
    
    Args:
        directory: 子目录路径（相对于工作空间），默认为工作空间根目录
        
    Returns:
        文件列表
    """
    workspace = _get_workspace()
    
    if directory:
        safe_path = _safe_path(workspace, directory)
        if not safe_path:
            return f"错误：路径不安全: {directory}"
        target_dir = safe_path
    else:
        target_dir = workspace
    
    if not target_dir.exists():
        return f"错误：目录不存在: {directory or '工作空间根目录'}"
    
    try:
        files = []
        for item in target_dir.iterdir():
            if item.is_file():
                files.append(f"[FILE] {item.name} ({item.stat().st_size} bytes)")
            elif item.is_dir():
                files.append(f"[DIR]  {item.name}/")
        
        if not files:
            return "(目录为空)"
        
        return "\n".join(sorted(files))
    
    except Exception as e:
        return f"错误：列出文件失败 - {str(e)}"


# ============================================================
# 工具集导出
# ============================================================

LOCAL_TOOLS = [
    write_local_file,
    read_local_file,
    update_mission_log,
    read_mission_log,
    list_local_files,
]

# 主代理本地工具（主要是账本管理）
MAIN_AGENT_LOCAL_TOOLS = [
    update_mission_log,
    read_mission_log,
]
