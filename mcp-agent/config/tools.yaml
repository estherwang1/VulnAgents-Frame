# ============================================================
# MCP Server 工具配置
# ============================================================
# 所有 MCP 工具在此定义，支持分组、参数校验、路由映射
# ============================================================

version: "2.0"

# 服务器配置（从 .env 读取）
server:
  name: "Pentest MCP Server"
  version: "2.0.0"
  host: "${MCP_HOST:0.0.0.0}"
  port: "${MCP_PORT:8000}"
  api_key: "${MCP_API_KEY:INTERNAL_TASK_2026}"

# 路径配置
paths:
  mcp_agent: "${MCP_AGENT_PATH:/root/mcp-agent}"
  workspace_root: "${WORKSPACE_ROOT:/root/pentest_workspace}"
  stamp_storage: "${STAMP_STORAGE_PATH:/root/pentest_workspace/.stamps}"
  toolbox: "${TOOLBOX_PATH:/root/mcp-agent/toolbox}"

# 执行配置
execution:
  command_timeout: "${COMMAND_TIMEOUT:120}"
  max_output_length: "${MAX_OUTPUT_LENGTH:2000}"
  max_script_size: "${MAX_SCRIPT_SIZE:102400}"

# 工具分组
groups:
  stamp:
    name: 任务戳管理
    description: 创建和管理渗透测试任务
  
  task:
    name: 任务执行
    description: 部署和执行测试脚本
  
  file:
    name: 文件操作
    description: 工作空间文件管理
  
  toolbox:
    name: 工具库
    description: 调用预装渗透测试工具
  
  system:
    name: 系统
    description: 底层系统命令

# ============================================================
# 工具定义
# ============================================================
tools:
  # === 任务戳管理 ===
  generate_stamp:
    group: stamp
    handler: stamp.generate_stamp
    description: 生成新的任务戳，用于追踪整个渗透测试任务
    params:
      mission_name:
        type: string
        required: true
        description: 任务名称
      target:
        type: string
        required: true
        description: 目标IP或域名
      operator:
        type: string
        required: false
        default: "shadow_commander"
        description: 操作者名称
      tags:
        type: array
        items: string
        required: false
        description: 任务标签

  get_stamp_info:
    group: stamp
    handler: stamp.get_stamp_info
    description: 获取任务戳详细信息
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID

  list_stamps:
    group: stamp
    handler: stamp.list_stamps
    description: 列出所有活跃的任务戳
    params: {}

  associate_task:
    group: stamp
    handler: stamp.associate_task
    description: 将任务ID关联到任务戳
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      task_id:
        type: string
        required: true
        description: 任务ID

  add_finding:
    group: stamp
    handler: stamp.add_finding
    description: 记录漏洞发现
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      vuln_type:
        type: string
        required: true
        description: 漏洞类型，如SQLi、XSS、IDOR等
      severity:
        type: string
        required: true
        enum: [critical, high, medium, low, info]
        description: 严重程度
      description:
        type: string
        required: true
        description: 漏洞描述
      evidence:
        type: object
        required: false
        description: 证据数据

  add_event:
    group: stamp
    handler: stamp.add_event
    description: 添加任务事件
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      event_type:
        type: string
        required: true
        description: 事件类型
      message:
        type: string
        required: true
        description: 事件消息
      data:
        type: object
        required: false
        description: 事件数据

  update_stamp_status:
    group: stamp
    handler: stamp.update_stamp_status
    description: 更新任务戳状态
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      status:
        type: string
        required: true
        enum: [active, completed, failed, paused]
        description: 状态
      notes:
        type: string
        required: false
        description: 备注

  archive_stamp:
    group: stamp
    handler: stamp.archive_stamp
    description: 归档任务戳
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID

  get_history:
    group: stamp
    handler: stamp.get_history
    description: 获取任务历史记录
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      limit:
        type: integer
        required: false
        default: 50
        description: 返回记录数量限制

  # === 任务执行 ===
  deploy_and_run_task:
    group: task
    handler: task.deploy_and_run
    description: 部署脚本到远程并执行
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      script_name:
        type: string
        required: true
        description: 脚本文件名，如 scanner.py
      script_content:
        type: string
        required: true
        description: 脚本完整内容

  get_task_status:
    group: task
    handler: task.get_task_status
    description: 获取任务执行状态
    params:
      stamp:
        type: string
        required: false
        description: 任务戳ID（可选，不填返回所有）
      task_id:
        type: string
        required: false
        description: 任务ID（可选）

  get_task_result:
    group: task
    handler: task.get_task_result
    description: 获取任务执行结果（日志内容）
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      task_id:
        type: string
        required: true
        description: 任务ID
      tail_lines:
        type: integer
        required: false
        default: 50
        description: 读取最后N行

  cancel_task:
    group: task
    handler: task.cancel_task
    description: 取消正在运行的任务
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      task_id:
        type: string
        required: true
        description: 任务ID

  # === 文件操作 ===
  list_workspace_files:
    group: file
    handler: file.list_workspace_files
    description: 列出任务戳工作空间中的文件
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID

  read_workspace_file:
    group: file
    handler: file.read_workspace_file
    description: 读取工作空间中的文件内容
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      filename:
        type: string
        required: true
        description: 文件名
      max_lines:
        type: integer
        required: false
        default: 100
        description: 最大读取行数

  # === 工具库（新增）===
  list_tools:
    group: toolbox
    handler: toolbox.list_tools
    description: 列出所有可用的渗透测试工具
    params:
      category:
        type: string
        required: false
        description: 按分类过滤
      tag:
        type: string
        required: false
        description: 按标签过滤

  get_tool_schema:
    group: toolbox
    handler: toolbox.get_tool_schema
    description: 获取工具详细参数说明
    params:
      tool_id:
        type: string
        required: true
        description: 工具ID，如 recon/port_scan

  run_tool:
    group: toolbox
    handler: toolbox.run_tool
    description: 运行渗透测试工具
    params:
      stamp:
        type: string
        required: true
        description: 任务戳ID
      tool_id:
        type: string
        required: true
        description: 工具ID，如 sqli/detect
      params:
        type: object
        required: true
        description: 工具参数

  # === 系统命令 ===
  execute_internal:
    group: system
    handler: system.execute_internal
    description: 执行远程shell命令（受白名单限制）
    security:
      require_whitelist: true
    params:
      command:
        type: string
        required: true
        description: 要执行的命令

# ============================================================
# 安全配置
# ============================================================
security:
  # 命令白名单
  command_whitelist:
    - "ls"
    - "cat"
    - "head"
    - "tail"
    - "grep"
    - "find"
    - "wc"
    - "pwd"
    - "whoami"
    - "id"
    - "ps"
    - "netstat"
    - "ss"
    - "ip"
    - "ping"
    - "nmap"
    - "curl"
    - "wget"
    - "python"
    - "python3"
    - "pip"
    - "pip3"
  
  # 禁止的命令模式
  command_blacklist:
    - "rm -rf /"
    - "mkfs"
    - "dd if="
    - "> /dev/"
    - "chmod 777"
    - ":(){ :|:& };:"
  
  # 路径限制
  allowed_paths:
    - "/root/pentest_workspace"
    - "/root/mcp-agent"
    - "/tmp"
